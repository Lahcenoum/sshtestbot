#!/bin/bash

# =================================================================
# سكربت لمراقبة اتصالات SSH وحذف الحسابات التي تتجاوز الحد المسموح
# الهدف: منع مشاركة الحسابات
# =================================================================

# --- الإعدادات (يمكنك تعديلها حسب حاجتك) ---

# 1. الحد الأقصى لعدد الاتصالات المتزامنة المسموح بها لكل مستخدم
# إذا قام المستخدم بفتح أكثر من هذا العدد من الجلسات، سيتم حذفه.
MAX_CONNECTIONS=2

# 2. بادئة أسماء المستخدمين التي سيتم مراقبتها
# السكربت سيراقب فقط المستخدمين الذين تبدأ أسماؤهم بهذه البادئة (مثل: user12ab, usercd34)
# هذا يضمن عدم حذف مستخدمي النظام أو المدير بالخطأ.
USER_PREFIX="user"

# 3. ملف لتسجيل عمليات الحذف والإجراءات
LOG_FILE="/var/log/ssh_monitor.log"


# --- الدالة الرئيسية للسكربت (لا تقم بتعديل ما لم تكن تعرف ماذا تفعل) ---

log_message() {
    # دالة لتسجيل الرسائل مع التاريخ والوقت
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

monitor_and_enforce() {
    log_message "بدء فحص مراقبة اتصالات SSH..."

    # استخدام أمر `who` للحصول على قائمة المستخدمين المتصلين حاليًا
    # ثم استخدام `awk` لعد عدد الجلسات لكل مستخدم فريد
    who | awk '{count[$1]++} END {for (user in count) print user, count[user]}' | while read -r username connections; do

        # التحقق فقط من المستخدمين الذين ينتمون للمجموعة المستهدفة (الذين أنشأهم البوت)
        if [[ "$username" == "$USER_PREFIX"* ]]; then

            log_message "فحص المستخدم: $username | عدد الاتصالات: $connections"

            # إذا تجاوز المستخدم الحد المسموح به من الاتصالات
            if [ "$connections" -gt "$MAX_CONNECTIONS" ]; then

                log_message "⚠️ تحذير: المستخدم $username تجاوز الحد المسموح به ($connections > $MAX_CONNECTIONS). سيتم حذف الحساب الآن."

                # الخطوة 1: قتل جميع عمليات المستخدم لإنهاء جميع جلساته فوراً
                log_message "إنهاء جميع جلسات المستخدم $username..."
                pkill -u "$username"
                # الانتظار قليلاً للتأكد من إنهاء العمليات قبل الحذف
                sleep 2

                # الخطوة 2: حذف المستخدم وحذف مجلده الشخصي (-r) بقوة (-f)
                log_message "حذف حساب المستخدم $username..."
                userdel -r -f "$username"

                if [ $? -eq 0 ]; then
                    log_message "✅ تم حذف المستخدم $username بنجاح بسبب مشاركة الحساب."
                else
                    log_message "❌ فشل حذف المستخدم $username. يرجى التحقق يدويًا."
                fi
            fi
        fi
    done

    log_message "انتهاء فحص المراقبة."
    echo "----------------------------------------" >> "$LOG_FILE"
}

# --- تنفيذ الدالة الرئيسية ---
monitor_and_enforce
