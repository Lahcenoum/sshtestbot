#!/bin/bash
# ========================================================================
#  السكريبت المدمج لمراقبة اتصالات WebSocket و UDPCustom
#  يقوم بحذف المستخدمين الذين يتجاوزون الحد المسموح به من إجمالي الاتصالات
# ========================================================================

# ===================== الإعدادات =====================
# الحد الأقصى لإجمالي الاتصالات (TCP + UDP) المسموح بها لكل مستخدم
MAX_CONNECTIONS=2

# المسار الكامل لملف قاعدة بيانات البوت
# !!! تأكد من تعديل هذا المسار ليتوافق مع مكان ملفك !!!
DB_FILE="/path/to/your/bot/ssh_bot_users.db"

# ملف لتسجيل الإجراءات (سيتم إنشاؤه تلقائياً)
LOG_FILE="/var/log/combined_monitor.log"

# بورتات WebSocket للمراقبة (مفصولة بـ |)
WS_PORTS_REGEX="80|8888|8080|8880"
# ====================================================

# دالة لكتابة سجلات
log_action() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}

# التحقق من وجود قاعدة البيانات
if [ ! -f "$DB_FILE" ]; then
    log_action "خطأ: ملف قاعدة البيانات غير موجود في المسار المحدد: $DB_FILE"
    exit 1
fi

log_action "بدء فحص جميع الاتصالات (TCP & UDP)..."

# الحصول على قائمة بأسماء المستخدمين النشطين من قاعدة البيانات
USERS=$(sqlite3 "$DB_FILE" "SELECT DISTINCT ssh_username FROM ssh_accounts;")

# المرور على كل مستخدم والتحقق من اتصالاته
for USER in $USERS; do
    # تجاهل إذا كان اسم المستخدم فارغاً
    if [ -z "$USER" ]; then
        continue
    fi

    # 1. حساب عدد اتصالات WebSocket (TCP) على البورتات المحددة
    WS_CONNECTIONS=$(lsof -n -P -iTCP -u "$USER" | grep -E ":(${WS_PORTS_REGEX})$" | wc -l)

    # 2. حساب عدد جميع اتصالات UDPCustom (UDP)
    UDP_CONNECTIONS=$(lsof -n -P -iUDP -u "$USER" | wc -l)

    # 3. حساب إجمالي الاتصالات
    TOTAL_CONNECTIONS=$((WS_CONNECTIONS + UDP_CONNECTIONS))

    # التحقق مما إذا كان المستخدم قد تجاوز الحد الإجمالي المسموح به
    if [ "$TOTAL_CONNECTIONS" -gt "$MAX_CONNECTIONS" ]; then
        log_action "تنبيه: المستخدم '$USER' لديه $TOTAL_CONNECTIONS اتصالات إجمالية ($WS_CONNECTIONS TCP, $UDP_CONNECTIONS UDP). الحد هو $MAX_CONNECTIONS. يتم الآن حذفه."
        
        # !! الإجراء: حذف المستخدم والمجلد الرئيسي الخاص به !!
        userdel -r "$USER"
        
        log_action "تم حذف المستخدم '$USER' بنجاح."
    fi
done

log_action "اكتمل فحص الاتصالات."
