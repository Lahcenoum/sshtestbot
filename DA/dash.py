#!/bin/bash

# ========================================================================
#          ๐ ุงูุณูุฑูุจุช ุงูุดุงูู ูุงูุฐูู ููุตูุงูุฉ ูุงููุณุฎ ุงูุงุญุชูุงุทู ๐
# ========================================================================

# --- โ๏ธ ุฅุนุฏุงุฏุงุช ูููุฉ ---
# ูุนุฑู ุงูููุงุฉ ุงูุฎุงุตุฉ ุจุงููุณุฎ ุงูุงุญุชูุงุทู (ุชู ุฅุถุงูุชู ุจูุงุกู ุนูู ุทูุจู)
# ููุงุญุธุฉ: ูุฌุจ ุฃู ูุจุฏุฃ ุงููุนุฑู ุจู -100
BACKUP_CHANNEL_ID="-1001002902787778"

# ุงููุณุงุฑ ุงููุงูู ูููู ูุงุนุฏุฉ ุงูุจูุงูุงุช
DB_PATH="/home/ssh_bot/ssh_bot_users.db"
BOT_FILE_PATH="/home/ssh_bot/bot.py"

# --- ููุงูุฉ ูุณู ุงูุฅุนุฏุงุฏุงุช ---


# --- ูุง ุชูู ุจุชุนุฏูู ุฃู ุดูุก ุจุนุฏ ูุฐุง ุงูุณุทุฑ ---

# --- ุฏูุงู ุงูุฃููุงู ---
red() { echo -e "\e[31m$*\e[0m"; }
green() { echo -e "\e[32m$*\e[0m"; }
yellow() { echo -e "\e[33m$*\e[0m"; }

# ุงูุชุญูู ูู ุตูุงุญูุงุช ุงูุฌุฐุฑ
if [ "$(id -u)" -ne 0 ]; then
    red "โ ูุฌุจ ุชุดุบูู ุงูุณูุฑุจุช ุจุตูุงุญูุงุช root."
    exit 1
fi

# --- ุงูุญุตูู ุนูู ุชููู ุงูุจูุช ุชููุงุฆููุง ---
echo "๐ ุฌุงุฑู ูุฑุงุกุฉ ุชููู ุงูุจูุช ูู ุงูููู..."
BOT_TOKEN=$(grep '^TOKEN =' "$BOT_FILE_PATH" | cut -d '"' -f 2)

if [ -z "$BOT_TOKEN" ] || [[ "$BOT_TOKEN" == "YOUR_TELEGRAM_BOT_TOKEN" ]]; then
    red "โ ุฎุทุฃ: ูู ูุชู ุงูุนุซูุฑ ุนูู ุชููู ุตุงูุญ ูู ููู bot.py."
    red "ูุฑุฌู ุงูุชุฃูุฏ ูู ุชุดุบูู ุณูุฑุจุช ุงูุชุซุจูุช ูุฅุฏุฎุงู ุงูุชููู ุฃููุงู."
    exit 1
fi
green "  - โ ุชู ุงูุนุซูุฑ ุนูู ุงูุชููู ุจูุฌุงุญ."


# --- 1. ุฅุฑุณุงู ุฑุณุงูุฉ ุงูุฅุฐุงุนุฉ ---

# ุชุนุฑูู ุงูุฑุณุงูุฉ
MAINTENANCE_MESSAGE=$(cat <<'END_MESSAGE'
๐ง **ุฅุดุนุงุฑ ุตูุงูุฉ ูุชุญุฏูุซ | Maintenance & Update Notice** ๐ง

**ุจุงูุนุฑุจูุฉ:**
ูุฑุญุจุงูุ ุณูุชู ุฅููุงู ุงูุจูุช ูุคูุชุงู ูุฅุฌุฑุงุก ุชุญุฏูุซุงุช ูุฅุตูุงุญุงุช.
ููุงุดุชุฑุงู ูู ุงูุณูุฑูุฑุงุช ุงููุฏููุนุฉ ุจุณุนุฑ **2 ุฏููุงุฑ**ุ ูุฑุฌู ุงูุงูุถูุงู ุฅูู ููุงุชูุง ูุงูุชูุงุตู ูุน ุงูุฃุฏูู ูู ููุงู:
https://t.me/CLOUDVIP

**English:**
Hello, the bot will be temporarily down for maintenance and bug fixes.
To subscribe to our premium servers for **$2**, please join our channel and contact the admin there:
https://t.me/CLOUDVIP
END_MESSAGE
)

echo "๐ข ุจุฏุก ุฅุฑุณุงู ุฑุณุงูุฉ ุงูุตูุงูุฉ ูููุณุชุฎุฏููู..."

# ุงูุญุตูู ุนูู ูุงุฆูุฉ ุงููุณุชุฎุฏููู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
USER_IDS=$(sqlite3 "$DB_PATH" "SELECT telegram_user_id FROM users;")

SUCCESS_COUNT=0
FAIL_COUNT=0

for user_id in $USER_IDS; do
    # ุฅุฑุณุงู ุงูุฑุณุงูุฉ ุจุงุณุชุฎุฏุงู cURL
    response=$(curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
    -d "chat_id=$user_id" \
    -d "text=$MAINTENANCE_MESSAGE" \
    -d "parse_mode=Markdown")

    if [[ $(echo "$response" | grep '"ok":true') ]]; then
        ((SUCCESS_COUNT++))
    else
        ((FAIL_COUNT++))
    fi
    sleep 0.1 # ูุชุฌูุจ ุฅุบุฑุงู ูุงุฌูุฉ ุชููุฌุฑุงู
done

green "โ ุงูุชููุช ุงูุฅุฐุงุนุฉ: ูุฌุญ ุงูุฅุฑุณุงู ูู $SUCCESS_COUNT ูุณุชุฎุฏูุ ููุดู ูู $FAIL_COUNT."

---

# --- 2. ุฅูุดุงุก ูุฅุฑุณุงู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ---

echo -e "\n๐๏ธ ุจุฏุก ุนูููุฉ ุงููุณุฎ ุงูุงุญุชูุงุทู ููุงุนุฏุฉ ุงูุจูุงูุงุช..."

if [ ! -f "$DB_PATH" ]; then
    red "โ ุฎุทุฃ: ูู ูุชู ุงูุนุซูุฑ ุนูู ููู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูู ุงููุณุงุฑ ุงููุญุฏุฏ."
    exit 1
fi

# ุฅูุดุงุก ูุณุฎุฉ ูุคูุชุฉ
BACKUP_FILE="/tmp/db_backup_$(date +%F_%H-%M-%S).db"
cp "$DB_PATH" "$BACKUP_FILE"
green "  - ุชู ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูุคูุชุฉ."

# ุฅุฑุณุงู ุงูููู ุฅูู ุงูููุงุฉ
CAPTION="ูุณุฎุฉ ุงุญุชูุงุทูุฉ ููุงุนุฏุฉ ุงูุจูุงูุงุช - $(date)"
echo "  - ๐ ุฌุงุฑู ุฅุฑุณุงู ุงูููู ุฅูู ุงูููุงุฉ..."
curl -s -F "chat_id=${BACKUP_CHANNEL_ID}" -F "document=@${BACKUP_FILE}" -F "caption=${CAPTION}" "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument" > /dev/null

# ุญุฐู ุงูููู ุงููุคูุช
rm "$BACKUP_FILE"
green "  - โ ุชู ุฅุฑุณุงู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุจูุฌุงุญ."

echo -e "\n=========================================="
green "๐ ุงูุชููุช ุฌููุน ุงูููุงู ุจูุฌุงุญ!"
echo "=========================================="

exit 0
