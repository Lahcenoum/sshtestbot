#!/bin/bash

# ========================================================================
#  Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ø´Ø§Ù…Ù„ - SSH Telegram Bot ÙˆÙ„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
# ========================================================================

# --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ© ---
GIT_REPO_URL="https://github.com/Lahcenoum/sshtestbot.git"
PROJECT_DIR="/home/ssh_bot"
CONNECTION_LIMIT=2

# --- Ù†Ù‡Ø§ÙŠØ© Ù‚Ø³Ù… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ---

# Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¬Ø°Ø±
if [ "$(id -u)" -ne 0 ]; then
  echo "âŒ ÙŠØ¬Ø¨ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø¨ØµÙ„Ø§Ø­ÙŠØ§Øª root."
  exit 1
fi

echo "=================================================="
echo "   ðŸ”§ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ø¨ÙˆØª ÙˆÙ„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…"
echo "=================================================="

# Ø§Ù„Ø®Ø·ÙˆØ© 0: Ø­Ø°Ù Ø£ÙŠ ØªØ«Ø¨ÙŠØª Ù‚Ø¯ÙŠÙ… Ù„Ø¶Ù…Ø§Ù† Ø¨Ø¯Ø§ÙŠØ© Ù†Ø¸ÙŠÙØ©
echo -e "\n[0/11] ðŸ—‘ï¸ Ø­Ø°Ù Ø£ÙŠ ØªØ«Ø¨ÙŠØª Ù‚Ø¯ÙŠÙ…..."
systemctl stop ssh_bot.service ssh_bot_dashboard.service >/dev/null 2>&1
systemctl disable ssh_bot.service ssh_bot_dashboard.service >/dev/null 2>&1
rm -f /etc/systemd/system/ssh_bot.service
rm -f /etc/systemd/system/ssh_bot_dashboard.service
rm -rf "$PROJECT_DIR"

# 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª
echo -e "\n[1/11] ðŸ“¦ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª..."
apt-get update
apt-get install -y git python3-venv python3-pip openssl sudo

# 2. Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
echo -e "\n[2/11] ðŸ“¥ Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù…Ù† GitHub..."
git clone "$GIT_REPO_URL" "$PROJECT_DIR"
cd "$PROJECT_DIR" || exit 1

# 3. Ø¥Ø¯Ø®Ø§Ù„ ØªÙˆÙƒÙ† Ø§Ù„Ø¨ÙˆØª
echo -e "\n[3/11] ðŸ”‘ Ø¥Ø¹Ø¯Ø§Ø¯ ØªÙˆÙƒÙ† Ø§Ù„Ø¨ÙˆØª..."
read -p "  - Ø£Ø¯Ø®Ù„ ØªÙˆÙƒÙ† Ø§Ù„Ø¨ÙˆØª: " BOT_TOKEN
if [ -z "$BOT_TOKEN" ]; then echo "âŒ Ù„Ù… ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªÙˆÙƒÙ†."; exit 1; fi
# ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙˆÙƒÙ† ÙÙŠ ÙƒÙ„Ø§ Ø§Ù„Ù…Ù„ÙÙŠÙ†
sed -i 's/^TOKEN = "YOUR_TELEGRAM_BOT_TOKEN".*/TOKEN = "'"$BOT_TOKEN"'"/' "$PROJECT_DIR/bot.py"
sed -i 's/^TOKEN = "YOUR_TELEGRAM_BOT_TOKEN".*/TOKEN = "'"$BOT_TOKEN"'"/' "$PROJECT_DIR/dashboard.py"
echo "  - âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙˆÙƒÙ† ÙÙŠ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¨ÙˆØª ÙˆÙ„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…."

# 4. Ø¥Ø¹Ø¯Ø§Ø¯ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
echo -e "\n[4/11] ðŸ›¡ï¸ Ø¥Ø¹Ø¯Ø§Ø¯ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…..."
read -p "  - Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (Ø§ØªØ±ÙƒÙ‡Ø§ ÙØ§Ø±ØºØ© Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… 'admin'): " DASH_PASSWORD
if [ -z "$DASH_PASSWORD" ]; then DASH_PASSWORD="admin"; fi
sed -i "s/^DASHBOARD_PASSWORD = \"admin\".*/DASHBOARD_PASSWORD = \"$DASH_PASSWORD\"/" "$PROJECT_DIR/dashboard.py"
echo "  - âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…."

# 5. Ø¥Ø¹Ø¯Ø§Ø¯ Ø³ÙƒØ±Ø¨Øª Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
echo -e "\n[5/11] ðŸ‘¤ Ø¥Ø¹Ø¯Ø§Ø¯ Ø³ÙƒØ±Ø¨Øª Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ø§Øª SSH..."
read -p "  - Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† IP Ø§Ù„Ø®Ø§Øµ Ø¨Ø³ÙŠØ±ÙØ±Ùƒ: " SERVER_IP
if [ -z "$SERVER_IP" ]; then echo "âŒ Ù„Ù… ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¢ÙŠ Ø¨ÙŠ."; exit 1; fi

if [ -f "create_ssh_user.sh" ]; then
    sed -i "s/YOUR_SERVER_IP/${SERVER_IP}/g" "create_ssh_user.sh"
    mv "create_ssh_user.sh" "/usr/local/bin/"
    chmod +x "/usr/local/bin/create_ssh_user.sh"
    echo "  - âœ… ØªÙ… Ù†Ù‚Ù„ ÙˆØ¥Ø¹Ø¯Ø§Ø¯ 'create_ssh_user.sh' Ø¨Ù†Ø¬Ø§Ø­."
else
    echo "  - âš ï¸ ØªØ­Ø°ÙŠØ±: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ 'create_ssh_user.sh'."
fi

# 6. Ø¥Ø¹Ø¯Ø§Ø¯ Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø­Ø°Ù Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
echo -e "\n[6/11] â³ Ø¥Ø¹Ø¯Ø§Ø¯ Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø­Ø°Ù Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†..."
if [ -f "delete_expired_users.sh" ]; then
    mv "delete_expired_users.sh" "/usr/local/bin/"
    chmod +x "/usr/local/bin/delete_expired_users.sh"
    (crontab -l 2>/dev/null | grep -v -F "/usr/local/bin/delete_expired_users.sh" ; echo "0 0 * * * /usr/local/bin/delete_expired_users.sh") | crontab -
    echo "  - âœ… ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ù‡Ù…Ø© Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ù…Ù†ØªÙ‡ÙŠØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­."
else
    echo "  - âš ï¸ ØªØ­Ø°ÙŠØ±: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù 'delete_expired_users.sh'."
fi

# 7. Ø¥Ø¹Ø¯Ø§Ø¯ Ø³ÙƒØ±Ø¨Øª Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª
echo -e "\n[7/11] ðŸ”— Ø¥Ø¹Ø¯Ø§Ø¯ Ø³ÙƒØ±Ø¨Øª Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©..."
if [ -f "monitor_connections.sh" ]; then
    sed -i "s/CONNECTION_LIMIT=[0-9]\+/CONNECTION_LIMIT=$CONNECTION_LIMIT/" "monitor_connections.sh"
    mv "monitor_connections.sh" "/usr/local/bin/"
    chmod +x "/usr/local/bin/monitor_connections.sh"
    (crontab -l 2>/dev/null | grep -v -F "/usr/local/bin/monitor_connections.sh" ; echo "*/5 * * * * /usr/local/bin/monitor_connections.sh") | crontab -
    echo "  - âœ… ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ù‡Ù…Ø© Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­."
else
    echo "  - âš ï¸ ØªØ­Ø°ÙŠØ±: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù 'monitor_connections.sh'."
fi

# 8. Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ¦Ø© Ø¨Ø§ÙŠØ«ÙˆÙ†
echo -e "\n[8/11] ðŸ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ÙˆØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª..."
python3 -m venv venv
(
  source venv/bin/activate
  pip install --upgrade pip
  if [ -f "requirements.txt" ]; then
    pip install -r requirements.txt
    echo "  - âœ… ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ù…Ù† requirements.txt."
  else
    pip install python-telegram-bot flask
    echo "  - âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ requirements.txtØŒ ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©."
  fi
)

# 9. Ø¥Ø¹Ø¯Ø§Ø¯ Ø®Ø¯Ù…Ø§Øª systemd
echo -e "\n[9/11] âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¯Ø§Ø¦Ù…Ø© (systemd)..."
# --- Ø®Ø¯Ù…Ø© Ø§Ù„Ø¨ÙˆØª ---
cat > /etc/systemd/system/ssh_bot.service << EOL
[Unit]
Description=Telegram SSH Bot Service
After=network.target

[Service]
User=root
Group=root
WorkingDirectory=${PROJECT_DIR}
ExecStart=${PROJECT_DIR}/venv/bin/python ${PROJECT_DIR}/bot.py
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOL

# --- Ø®Ø¯Ù…Ø© Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ---
cat > /etc/systemd/system/ssh_bot_dashboard.service << EOL
[Unit]
Description=Telegram SSH Bot Dashboard
After=network.target

[Service]
User=root
Group=root
WorkingDirectory=${PROJECT_DIR}
ExecStart=${PROJECT_DIR}/venv/bin/python ${PROJECT_DIR}/dashboard.py
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOL
echo "  - âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„ÙØ§Øª Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø¨Ù†Ø¬Ø§Ø­."

# 10. ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª
echo -e "\n[10/11] ðŸš€ ØªÙ…ÙƒÙŠÙ† ÙˆØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª..."
systemctl daemon-reload
systemctl enable ssh_bot.service ssh_bot_dashboard.service
systemctl restart ssh_bot.service ssh_bot_dashboard.service

# 11. Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ«Ø¨ÙŠØª
echo -e "\n[11/11] ðŸŽ‰ ØªÙ… Ø§Ù„ØªØ«Ø¨ÙŠØª Ø¨Ù†Ø¬Ø§Ø­!"
echo "=================================================="
echo "  - ðŸ¤– Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¨ÙˆØª: systemctl status ssh_bot.service"
echo "  - ðŸ“Š Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…: systemctl status ssh_bot_dashboard.service"
echo "  - ðŸŒ Ø±Ø§Ø¨Ø· Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…: http://${SERVER_IP}:5000"
echo "=================================================="
