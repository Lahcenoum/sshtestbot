#!/bin/bash

# ==============================================================================
#  سكربت لحذف قاعدة بيانات المستخدمين وإعادة تهيئة البوت
# ==============================================================================

# --- إعدادات ---
DB_FILE="/home/ssh_bot/ssh_bot_users.db"
BOT_SERVICE="ssh_bot.service"
# --- نهاية الإعدادات ---

# التحقق من أن السكربت يعمل بصلاحيات الجذر
if [ "$(id -u)" -ne 0 ]; then
  echo "❌ هذا السكربت يجب أن يعمل بصلاحيات الجذر. يرجى استخدام 'sudo'."
  exit 1
fi

echo "⚠️ سيتم حذف قاعدة بيانات المستخدمين بشكل نهائي."
read -p "هل أنت متأكد من أنك تريد المتابعة؟ (y/n): " confirm
if [[ "$confirm" != "y" ]]; then
    echo "تم إلغاء العملية."
    exit 0
fi

echo -e "\n[1/3] إيقاف خدمة البوت..."
systemctl stop "$BOT_SERVICE"

if [ -f "$DB_FILE" ]; then
    echo "[2/3] حذف ملف قاعدة البيانات: $DB_FILE"
    rm "$DB_FILE"
    echo "-> تم حذف قاعدة البيانات بنجاح."
else
    echo "[2/3] لم يتم العثور على ملف قاعدة البيانات. لا يوجد شيء ليتم حذفه."
fi

echo "[3/3] إعادة تشغيل خدمة البوت..."
systemctl start "$BOT_SERVICE"

echo -e "\n✅ اكتملت العملية. سيقوم البوت الآن بإنشاء قاعدة بيانات جديدة وفارغة."
