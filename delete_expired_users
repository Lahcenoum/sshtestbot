#!/bin/bash

# =================================================================
#  سكربت محسن لحذف حسابات SSH المنتهية التي أنشأها البوت
# =================================================================

# --- الإعدادات ---
# البادئة التي يستخدمها البوت لإنشاء أسماء المستخدمين
USER_PREFIX="user"

# ملف لتسجيل عمليات الحذف
LOG_FILE="/var/log/expired_users_cleanup.log"


# --- الدالة الرئيسية ---

log_message() {
    # دالة لتسجيل الرسائل مع التاريخ والوقت
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}

log_message "بدء عملية تنظيف الحسابات المنتهية الصلاحية..."

# الحصول على تاريخ اليوم بالثواني للمقارنة الدقيقة
TODAY_SECS=$(date +%s)

# قراءة ملف المستخدمين
while IFS=: read -r username _ uid _ _ _ _; do
    # التحقق من أن المستخدم هو مستخدم عادي (uid >= 1000) وأنه تم إنشاؤه بواسطة البوت
    if [[ $uid -ge 1000 && "$username" == "$USER_PREFIX"* ]]; then

        # الحصول على تاريخ انتهاء صلاحية الحساب
        expiry_str=$(chage -l "$username" | grep "Account expires" | awk -F': ' '{print $2}')

        # التحقق من أن الحساب له تاريخ انتهاء صلاحية (وليس "never")
        if [[ "$expiry_str" != "never" && -n "$expiry_str" ]]; then

            # تحويل تاريخ الانتهاء إلى ثوانٍ للمقارنة
            expiry_secs=$(date -d "$expiry_str" +%s)

            # إذا كان تاريخ الانتهاء قد حل (أصغر من أو يساوي تاريخ اليوم)
            if [[ "$expiry_secs" -le "$TODAY_SECS" ]]; then
                log_message "المستخدم '$username' منتهي الصلاحية (تاريخ الانتهاء: $expiry_str). سيتم حذفه الآن."

                # حذف المستخدم مع مجلده الشخصي (-r) بقوة (-f)
                userdel -r -f "$username"

                if [ $? -eq 0 ]; then
                    log_message "✅ تم حذف المستخدم '$username' بنجاح."
                else
                    log_message "❌ فشل حذف المستخدم '$username'."
                fi
            fi
        fi
    fi
done < /etc/passwd

log_message "انتهاء عملية التنظيف."
echo "----------------------------------------" >> "$LOG_FILE"
