#!/bin/bash

# ========================================================================
#  سكريبت لإعادة ضبط بوت SSH بالكامل
#  - يحذف جميع حسابات SSH التي أنشأها البوت
#  - يحذف قاعدة البيانات ليعود جميع المستخدمين إلى نقطة الصفر
# ========================================================================

# --- إعدادات ---
# البادئة الخاصة بأسماء المستخدمين الذين سيتم حذفهم
USER_PREFIX="sshdatbot"
# المسار إلى ملف قاعدة البيانات
DB_FILE="/home/ssh_bot/ssh_bot_users.db"
# اسم خدمة البوت
SERVICE_NAME="ssh_bot.service"

# --- بداية السكريبت ---

echo "⚠️ تحذير: هذا السكريبت سيقوم بحذف جميع حسابات SSH التي أنشأها البوت وقاعدة بيانات المستخدمين بالكامل."
read -p "هل أنت متأكد أنك تريد المتابعة؟ (اكتب 'نعم' للتأكيد): " CONFIRMATION

if [ "$CONFIRMATION" != "نعم" ]; then
    echo "تم إلغاء العملية."
    exit 0
fi

echo "----------------------------------------"

# 1. إيقاف خدمة البوت
echo "🔄 [1/4] جاري إيقاف خدمة البوت..."
systemctl stop "$SERVICE_NAME"

# 2. حذف جميع حسابات SSH التي أنشأها البوت
echo "🔥 [2/4] جاري حذف جميع حسابات SSH التي تبدأ بـ '$USER_PREFIX'..."
for USERNAME in $(getent passwd | cut -d: -f1 | grep "^$USER_PREFIX"); do
    echo "   - حذف المستخدم: $USERNAME"
    userdel -r "$USERNAME"
done
echo "✅ تم حذف حسابات SSH بنجاح."

# 3. حذف ملف قاعدة البيانات
echo "🗑️ [3/4] جاري حذف ملف قاعدة البيانات..."
if [ -f "$DB_FILE" ]; then
    rm -f "$DB_FILE"
    echo "✅ تم حذف قاعدة البيانات بنجاح."
else
    echo "ℹ️ لم يتم العثور على ملف قاعدة البيانات (ربما تم حذفه مسبقًا)."
fi

# 4. إعادة تشغيل خدمة البوت
echo "🚀 [4/4] جاري إعادة تشغيل خدمة البوت..."
systemctl start "$SERVICE_NAME"
sleep 3 # انتظر قليلاً للتأكد من أن الخدمة بدأت

if systemctl is-active --quiet "$SERVICE_NAME"; then
    echo "🎉 اكتملت عملية إعادة الضبط بنجاح! البوت يعمل الآن بقاعدة بيانات نظيفة."
else
    echo "❌ فشلت عملية إعادة الضبط. يرجى التحقق من حالة الخدمة يدويًا باستخدام: systemctl status $SERVICE_NAME"
fi

echo "----------------------------------------"
