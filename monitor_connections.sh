#!/bin/bash
# ========================================================================
#  السكريبت النهائي لمراقبة الاتصالات (يعتمد على عدّ العمليات)
#  يقوم بحذف المستخدمين الذين يتجاوزون الحد المسموح به من الجلسات النشطة
# ========================================================================

# ===================== الإعدادات =====================
# الحد الأقصى للجلسات النشطة المسموح بها لكل مستخدم
MAX_SESSIONS=1

# المسار الكامل لملف قاعدة بيانات البوت
DB_FILE="/home/ssh_bot/ssh_bot_users.db"

# ملف لتسجيل الإجراءات
LOG_FILE="/var/log/combined_monitor.log"
# ====================================================

# دالة لكتابة سجلات
log_action() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}

# التحقق من وجود قاعدة البيانات
if [ ! -f "$DB_FILE" ]; then
    log_action "خطأ: ملف قاعدة البيانات غير موجود في المسار المحدد: $DB_FILE"
    exit 1
fi

log_action "بدء فحص جلسات SSH النشطة..."

# الحصول على قائمة بأسماء المستخدمين من قاعدة البيانات
USERS=$(sqlite3 "$DB_FILE" "SELECT DISTINCT ssh_username FROM ssh_accounts;")

# المرور على كل مستخدم والتحقق من جلساته
for USER in $USERS; do
    # تجاهل إذا كان اسم المستخدم فارغاً
    if [ -z "$USER" ]; then
        continue
    fi

    # !! الطريقة الجديدة: عدّ عمليات sshd النشطة للمستخدم !!
    # يبحث عن العمليات التي يملكها المستخدم والتي تبدو مثل "sshd: user [priv]"
    CURRENT_SESSIONS=$(ps -u "$USER" -o comm= | grep -c '^sshd$')

    # التحقق مما إذا كان المستخدم قد تجاوز الحد المسموح به
    if [ "$CURRENT_SESSIONS" -gt "$MAX_SESSIONS" ]; then
        log_action "تنبيه: المستخدم '$USER' لديه $CURRENT_SESSIONS جلسات نشطة (الحد هو $MAX_SESSIONS). يتم الآن حذفه."
        
        # الإجراء: حذف المستخدم والمجلد الرئيسي الخاص به
        userdel -r "$USER"
        
        log_action "تم حذف المستخدم '$USER' بنجاح."
    fi
done

log_action "اكتمل فحص الجلسات."
