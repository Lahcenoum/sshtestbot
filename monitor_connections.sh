#!/bin/bash
# ========================================================================
#  سكريبت المراقبة (نسخة الاختبار) - يعرض عدد الجلسات لكل مستخدم
#  **محدث ليراقب جميع المستخدمين الذين يبدأ اسمهم بـ sshdatbot**
# ========================================================================

# ===================== الإعدادات =====================
# الحد الأقصى للجلسات (غير مستخدم في هذه النسخة، للحفاظ على التوافق)
MAX_SESSIONS=1

# ملف لتسجيل الإجراءات
LOG_FILE="/var/log/combined_monitor.log"
# ====================================================

# دالة لكتابة سجلات
log_action() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}

log_action "--- بدء فحص الجلسات (وضع الاختبار) ---"

# !! التعديل الرئيسي: الحصول على قائمة المستخدمين مباشرة من النظام !!
# يبحث عن كل مستخدمي النظام الذين يبدأ اسمهم بـ "sshdatbot"
USERS=$(getent passwd | cut -d: -f1 | grep '^sshdatbot')

# المرور على كل مستخدم وتسجيل عدد جلساته
for USER in $USERS; do
    # تجاهل إذا كان اسم المستخدم فارغاً
    if [ -z "$USER" ]; then
        continue
    fi

    # عدّ عمليات sshd النشطة للمستخدم
    CURRENT_SESSIONS=$(ps -u "$USER" -o comm= | grep -c '^sshd$')

    # تسجيل عدد الجلسات لكل مستخدم متصل
    if [ "$CURRENT_SESSIONS" -gt 0 ]; then
        log_action "مراقبة: المستخدم '$USER' لديه $CURRENT_SESSIONS جلسات نشطة."
    fi
done

log_action "--- اكتمل فحص الجلسات (وضع الاختبار) ---"
