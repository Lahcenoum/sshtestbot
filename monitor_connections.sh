#!/bin/bash
# ========================================================================
#  سكريبت المراقبة (نسخة الاختبار) - يعرض عدد الجلسات لكل مستخدم
# ========================================================================

# ===================== الإعدادات =====================
# الحد الأقصى للجلسات (غير مستخدم في هذه النسخة، للحفاظ على التوافق)
MAX_SESSIONS=1

# المسار الكامل لملف قاعدة بيانات البوت
DB_FILE="/home/ssh_bot/ssh_bot_users.db"

# ملف لتسجيل الإجراءات
LOG_FILE="/var/log/combined_monitor.log"
# ====================================================

# دالة لكتابة سجلات
log_action() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}

# التحقق من وجود قاعدة البيانات
if [ ! -f "$DB_FILE" ]; then
    log_action "خطأ: ملف قاعدة البيانات غير موجود في المسار المحدد: $DB_FILE"
    exit 1
fi

log_action "--- بدء فحص الجلسات (وضع الاختبار) ---"

# الحصول على قائمة بأسماء المستخدمين من قاعدة البيانات
USERS=$(sqlite3 "$DB_FILE" "SELECT DISTINCT ssh_username FROM ssh_accounts;")

# المرور على كل مستخدم وتسجيل عدد جلساته
for USER in $USERS; do
    # تجاهل إذا كان اسم المستخدم فارغاً
    if [ -z "$USER" ]; then
        continue
    fi

    # عدّ عمليات sshd النشطة للمستخدم
    CURRENT_SESSIONS=$(ps -u "$USER" -o comm= | grep -c '^sshd$')

    # !! التعديل الرئيسي: تسجيل عدد الجلسات بدلاً من الحذف !!
    # سيتم تسجيل هذا السطر لكل مستخدم موجود في قاعدة البيانات
    if [ "$CURRENT_SESSIONS" -gt 0 ]; then
        log_action "مراقبة: المستخدم '$USER' لديه $CURRENT_SESSIONS جلسات نشطة."
    fi
done

log_action "--- اكتمل فحص الجلسات (وضع الاختبار) ---"
